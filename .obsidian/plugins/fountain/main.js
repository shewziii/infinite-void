/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var qs=Object.create;var Re=Object.defineProperty;var Ws=Object.getOwnPropertyDescriptor;var _s=Object.getOwnPropertyNames;var Ks=Object.getPrototypeOf,Us=Object.prototype.hasOwnProperty;var js=(r,s)=>()=>(r&&(s=r(r=0)),s);var zs=(r,s)=>()=>(s||r((s={exports:{}}).exports,s),s.exports),wt=(r,s)=>{for(var e in s)Re(r,e,{get:s[e],enumerable:!0})},xt=(r,s,e,l)=>{if(s&&typeof s=="object"||typeof s=="function")for(let f of _s(s))!Us.call(r,f)&&f!==e&&Re(r,f,{get:()=>s[f],enumerable:!(l=Ws(s,f))||l.enumerable});return r};var Xs=(r,s,e)=>(e=r!=null?qs(Ks(r)):{},xt(s||!r||!r.__esModule?Re(e,"default",{value:r,enumerable:!0}):e,r)),Tt=r=>xt(Re({},"__esModule",{value:!0}),r);var $t={};wt($t,{FountainScript:()=>Ye,NBSP:()=>U,StructureScene:()=>ne,StructureSection:()=>ce,dataRange:()=>R,escapeHtml:()=>bt,extractNotes:()=>fe,intersect:()=>Je,isBlankLines:()=>Ys,mergeText:()=>Js});function R(r){return{"data-range":`${r.start},${r.end}`}}function Je(r,s){return r.start<s.end&&s.start<r.end}function fe(r){let s=[];for(let e of r)if("lines"in e)for(let l of e.lines)for(let f of l.elements)f.kind==="note"&&s.push(f);return s}function Ys(r){return r.kind==="action"&&r.lines.length>=1&&r.lines.every(s=>s.elements.length===0)}function Js(r){let s=[];if(r.length===0)return[];let e=r[0];for(let l=1;l<r.length;l++){let f=r[l];f.kind==="text"&&e.kind==="text"?e={kind:"text",range:{start:e.range.start,end:f.range.end}}:(s.push(e),e=f)}return s.push(e),s}function bt(r){return r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function Ae(r,s){return r?s.replace(/^( +)/gm,(e,l)=>U.repeat(l.length)):s}function Gs(r){let s=[],e=null;for(let l of r)if(e===null)e=l;else{let f=[];e.kind==="action"&&l.kind==="action"?(e.lines.length>0&&e.range.end>e.lines[e.lines.length-1].range.end&&(f=[{range:{start:e.range.end-1,end:e.range.end},elements:[],centered:!1}]),e={kind:"action",lines:e.lines.concat(f,l.lines),range:{start:e.range.start,end:l.range.end}}):(s.push(e),e=l)}return e!==null&&s.push(e),s}var U,ce,ne,Ye,j=js(()=>{"use strict";U="\xA0";ce=class{constructor(s,e){this.section=s;this.synopsis=e;this.kind="section",this.content=[]}get range(){var l,f,h,p;let s=[(l=this.synopsis)==null?void 0:l.range.start,(f=this.content[0])==null?void 0:f.range.start].filter(v=>v!==void 0),e=[(h=this.synopsis)==null?void 0:h.range.end,(p=this.content[this.content.length-1])==null?void 0:p.range.end].filter(v=>v!==void 0);return{start:Math.min(...s),end:Math.max(...e)}}},ne=class{constructor(s,e){this.scene=s;this.synopsis=e;this.content=[],this.kind="scene"}get range(){var l,f,h,p,v,E;let s=[(l=this.scene)==null?void 0:l.range.start,(f=this.synopsis)==null?void 0:f.range.start,(h=this.content[0])==null?void 0:h.range.start].filter(y=>y!==void 0),e=[(p=this.scene)==null?void 0:p.range.end,(v=this.synopsis)==null?void 0:v.range.end,(E=this.content[this.content.length-1])==null?void 0:E.range.end].filter(y=>y!==void 0);return{start:Math.min(...s),end:Math.max(...e)}}},Ye=class{extractAsHtml(s,e=!1){let l=bt(this.unsafeExtractRaw(s));return Ae(e,l)}unsafeExtractRaw(s,e=!1){return Ae(e,this.document.slice(s.start,s.end))}charactersOf(s){return this.document.slice(s.characterRange.start,s.characterRange.end).split("&").map(l=>l.trim())}styledTextToHtml(s,e,l,f){let h=!0;for(let p of e)h=!this.renderTextElement(s,p,l,f)&&h;return!h||e.length>0}renderStyledTextElement(s,e,l){s.createEl("span",{cls:e.kind},f=>{for(let h of e.elements)this.renderTextElement(s,h,l,!1)})}renderTextElement(s,e,l,f){switch(e.kind){case"text":return s.appendText(Ae(f,this.unsafeExtractRaw(e.range))),!0;case"bold":case"italics":case"underline":return this.renderStyledTextElement(s,e,l),!0;case"note":{if(l.hideNotes)return!1;let h="";switch(e.noteKind){case"+":h="note-symbol-plus";break;case"-":h="note-symbol-minus";break;case"todo":h="note-todo";break;default:h="note";break}s.createEl("span",{cls:h,attr:R(e.range)},p=>{e.noteKind==="todo"&&p.createEl("b",{text:"TODO: "}),p.appendText(Ae(!0,this.unsafeExtractRaw(e.textRange)))})}return!0;case"boneyard":return!1}}constructor(s,e,l){this.document=s,this.titlePage=e,this.script=Gs(l);let f=new Set;for(let h of this.script)switch(h.kind){case"dialogue":for(let p of this.charactersOf(h))f.add(p);break;default:break}this.allCharacters=f}with_source(){return this.script.map(s=>({...s,source:this.document.slice(s.range.start,s.range.end)}))}structure(){let s=[],e=new ce,l=new ne,f=()=>!l.content.length&&!l.scene&&!l.synopsis,h=()=>f()&&!e.content&&!e.section&&!e.synopsis,p=()=>l.content.every(v=>v.kind==="action"&&v.lines.every(E=>!E.elements.length));for(let v of this.script)switch(v.kind){case"section":v.depth<=3?h()?e.section=v:(f()||(e.content.push(l),l=new ne),s.push(e),e=new ce(v)):l.content.push(v);break;case"scene":f()||e.content.push(l),l=new ne(v);break;case"synopsis":!l.synopsis&&!l.scene&&p()&&!e.content.length&&e.section?e.synopsis=v:!l.synopsis&&l.scene&&p()?l.synopsis=v:l.content.push(v);break;default:l.content.push(v);break}return f()||e.content.push(l),h()||s.push(e),s}}});var At=zs((Rr,Rt)=>{"use strict";var kt=(j(),Tt($t)),Qs=kt.FountainScript,se=kt.mergeText;function Zs(r,s){function e(){this.constructor=r}e.prototype=s.prototype,r.prototype=new e}function W(r,s,e,l){var f=Error.call(this,r);return Object.setPrototypeOf&&Object.setPrototypeOf(f,W.prototype),f.expected=s,f.found=e,f.location=l,f.name="SyntaxError",f}Zs(W,Error);function Ge(r,s,e){return e=e||" ",r.length>s?r:(s-=r.length,e+=e.repeat(s),r+e.slice(0,s))}W.prototype.format=function(r){var s="Error: "+this.message;if(this.location){var e=null,l;for(l=0;l<r.length;l++)if(r[l].source===this.location.source){e=r[l].text.split(/\r\n|\n|\r/g);break}var f=this.location.start,h=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(f):f,p=this.location.source+":"+h.line+":"+h.column;if(e){var v=this.location.end,E=Ge("",h.line.toString().length," "),y=e[f.line-1],S=f.line===v.line?v.column:y.length+1,T=S-f.column||1;s+=`
 --> `+p+`
`+E+` |
`+h.line+" | "+y+`
`+E+" | "+Ge("",f.column-1," ")+Ge("",T,"^")}else s+=`
 at `+p}return s};W.buildMessage=function(r,s){var e={literal:function(y){return'"'+f(y.text)+'"'},class:function(y){var S=y.parts.map(function(T){return Array.isArray(T)?h(T[0])+"-"+h(T[1]):h(T)});return"["+(y.inverted?"^":"")+S.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(y){return y.description}};function l(y){return y.charCodeAt(0).toString(16).toUpperCase()}function f(y){return y.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(S){return"\\x0"+l(S)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(S){return"\\x"+l(S)})}function h(y){return y.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(S){return"\\x0"+l(S)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(S){return"\\x"+l(S)})}function p(y){return e[y.type](y)}function v(y){var S=y.map(p),T,L;if(S.sort(),S.length>0){for(T=1,L=1;T<S.length;T++)S[T-1]!==S[T]&&(S[L]=S[T],L++);S.length=L}switch(S.length){case 1:return S[0];case 2:return S[0]+" or "+S[1];default:return S.slice(0,-1).join(", ")+", or "+S[S.length-1]}}function E(y){return y?'"'+f(y)+'"':"end of input"}return"Expected "+v(r)+" but "+E(s)+" found."};function er(r,s){s=s!==void 0?s:{};var e={},l=s.grammarSource,f={Script:ut},h=ut,p=`
`,v=":",E=" ",y="	",S="=",T="**",L="*",V="_",b="<",he=`<
`,ge=">",Ot="!",pe=`TO:
`,X="TO:",nt="[[",Y="]]",J=`

`,qt="+",Wt="-",st="/*",G="*/",rt="#",Ve="(",Ne=")",_t="@",Kt=".",Ut="int./ext",jt="int/ext",zt="ext",Xt="est",Yt="int",Jt="i/e",M=/^[ \t]/,Gt=/^[a-zA-Z0-9_]/,it=/^[a-zA-Z0-9_ ]/,ve=/^[^\n]/,Ie=/^[a-zA-Z0-9]/,Q=/^[^)\n]/,me=/^[^(\n]/,Qt=/^[^ >\t\n]/,Zt=/^[ .]/,F=hs(),N=x(`
`,!1),at=x(":",!1),C=P([" ","	"],!1,!1),en=P([["a","z"],["A","Z"],["0","9"],"_"],!1,!1),ot=P([["a","z"],["A","Z"],["0","9"],"_"," "],!1,!1),ye=x(" ",!1),tn=x("	",!1),Pe=x("=",!1),Ee=x("**",!1),Se=x("*",!1),we=x("_",!1),nn=x("<",!1),sn=x(`<
`,!1),rn=x(">",!1),an=x("!",!1),lt=x(`TO:
`,!1),Be=x("TO:",!1),xe=P([`
`],!0,!1),on=je("note"),ln=x("[[",!1),Oe=x("]]",!1),qe=x(`

`,!1),cn=x("+",!1),fn=x("-",!1),We=P([["a","z"],["A","Z"],["0","9"]],!1,!1),dn=je("boneyard"),un=x("/*",!1),_e=x("*/",!1),ct=x("#",!1),Ke=x("(",!1),Z=P([")",`
`],!0,!1),Ue=x(")",!1),hn=x("@",!1),Te=P(["(",`
`],!0,!1),gn=P([" ",">","	",`
`],!0,!1),pn=x(".",!1),vn=x("INT./EXT",!0),mn=x("INT/EXT",!0),yn=x("EXT",!0),En=x("EST",!0),Sn=x("INT",!0),wn=x("I/E",!0),xn=P([" ","."],!1,!1),Tn=function(n,a){return new Qs(r,n||[],a)},bn=function(n){return n},$n=function(n,a){return{range:k(),key:n,values:a}},kn=function(){return ae()},Rn=function(n){return[n]},An=function(n){return se(n)},Ln=function(n){return n},Mn=function(n){return n},Cn=function(){return{range:k(),kind:"page-break"}},Hn=function(n){return n},Dn=function(n){return n},Fn=function(n){return n},Vn=function(n){return{range:k(),kind:"bold",elements:se(n)}},Nn=function(n){return{range:k(),kind:"italics",elements:se(n)}},In=function(n){return{range:k(),kind:"underline",elements:se(n)}},Pn=function(){return{range:k(),kind:"text"}},Bn=function(n,a){return{range:k(),centered:!1,elements:se(n)}},On=function(n){return{range:k(),centered:!0,elements:se(n)}},qn=function(n){return n.range.start=n.range.start-1,n},Wn=function(){let n=ae();return n.toUpperCase()===n},_n=function(){return{kind:"transition",range:k()}},Kn=function(n){return{kind:"action",range:k(),lines:n}},Un=function(n){return{kind:"action",range:n,lines:[{range:n,centered:!1,elements:[]}]}},jn=function(n,a){return{range:k(),kind:"note",noteKind:(n!=null?n:"").toLowerCase(),textRange:a}},zn=function(){return k()},Xn=function(){return"+"},Yn=function(){return"-"},Jn=function(n){return n},Gn=function(){return ae()},Qn=function(){return{range:k(),kind:"boneyard"}},Zn=function(n){return{range:k(),depth:n,kind:"section"}},es=function(){return ae().length},ts=function(n){return{range:k(),kind:"synopsis",linesOfText:n}},ns=function(n){return n},ss=function(){return k()},rs=function(n,a,i,o){return{range:k(),kind:"dialogue",characterRange:n,characterExtensionsRange:a,parenthetical:i,lines:o}},is=function(){return k()},as=function(){return k()},os=function(n){return n.toUpperCase()===n},ls=function(n){return k()},cs=function(){return k()},fs=function(){return ae()},ds=function(){return k()},us=function(){return{kind:"scene",range:k()}},t=s.peg$currPos|0,w=t,ee=[{line:1,column:1}],I=t,be=s.peg$maxFailExpected||[],d=s.peg$silentFails|0,ie;if(s.startRule){if(!(s.startRule in f))throw new Error(`Can't start parsing from rule "`+s.startRule+'".');h=f[s.startRule]}function ae(){return r.substring(w,t)}function xr(){return w}function k(){return{source:l,start:w,end:t}}function Tr(){return oe(w,t)}function br(n,a){throw a=a!==void 0?a:oe(w,t),dt([je(n)],r.substring(w,t),a)}function $r(n,a){throw a=a!==void 0?a:oe(w,t),ps(n,a)}function x(n,a){return{type:"literal",text:n,ignoreCase:a}}function P(n,a,i){return{type:"class",parts:n,inverted:a,ignoreCase:i}}function hs(){return{type:"any"}}function gs(){return{type:"end"}}function je(n){return{type:"other",description:n}}function ft(n){var a=ee[n],i;if(a)return a;if(n>=ee.length)i=ee.length-1;else for(i=n;!ee[--i];);for(a=ee[i],a={line:a.line,column:a.column};i<n;)r.charCodeAt(i)===10?(a.line++,a.column=1):a.column++,i++;return ee[n]=a,a}function oe(n,a,i){var o=ft(n),c=ft(a),u={source:l,start:{offset:n,line:o.line,column:o.column},end:{offset:a,line:c.line,column:c.column}};return i&&l&&typeof l.offset=="function"&&(u.start=l.offset(u.start),u.end=l.offset(u.end)),u}function g(n){t<I||(t>I&&(I=t,be=[]),be.push(n))}function ps(n,a){return new W(n,null,null,a)}function dt(n,a,i){return new W(W.buildMessage(n,a),n,a,i)}function ut(){var n,a,i,o,c;for(n=t,a=vs(),a===e&&(a=null),i=[],o=vt();o!==e;)i.push(o),o=vt();return o=t,d++,r.length>t?(c=r.charAt(t),t++):(c=e,d===0&&g(F)),d--,c===e?o=void 0:(t=o,o=e),o!==e?(w=n,n=Tn(a,i)):(t=n,n=e),n}function vs(){var n,a,i;if(n=t,a=[],i=ht(),i!==e)for(;i!==e;)a.push(i),i=ht();else a=e;return a!==e?(r.charCodeAt(t)===10?(i=p,t++):(i=e,d===0&&g(N)),i!==e?(w=n,n=bn(a)):(t=n,n=e)):(t=n,n=e),n}function ht(){var n,a,i,o,c,u;if(n=t,a=ms(),a!==e)if(r.charCodeAt(t)===58?(i=v,t++):(i=e,d===0&&g(at)),i!==e){for(o=[],c=r.charAt(t),M.test(c)?t++:(c=e,d===0&&g(C));c!==e;)o.push(c),c=r.charAt(t),M.test(c)?t++:(c=e,d===0&&g(C));c=t,u=ys(),u!==e?c=u:(t=c,c=e),c===e&&(c=t,u=Es(),u!==e?c=u:(t=c,c=e)),c!==e?(w=n,n=$n(a,c)):(t=n,n=e)}else t=n,n=e;else t=n,n=e;return n}function ms(){var n,a,i,o;if(n=t,a=r.charAt(t),Gt.test(a)?t++:(a=e,d===0&&g(en)),a!==e){for(i=[],o=r.charAt(t),it.test(o)?t++:(o=e,d===0&&g(ot));o!==e;)i.push(o),o=r.charAt(t),it.test(o)?t++:(o=e,d===0&&g(ot));w=n,n=kn()}else t=n,n=e;return n}function ys(){var n,a,i;return n=t,a=gt(),a!==e?(r.charCodeAt(t)===10?(i=p,t++):(i=e,d===0&&g(N)),i!==e?(w=n,n=Rn(a)):(t=n,n=e)):(t=n,n=e),n}function gt(){var n,a,i;if(n=t,a=[],i=B(),i!==e)for(;i!==e;)a.push(i),i=B();else a=e;return a!==e&&(w=n,a=An(a)),n=a,n}function Es(){var n,a,i,o,c,u;if(n=t,r.charCodeAt(t)===10?(a=p,t++):(a=e,d===0&&g(N)),a!==e){if(i=[],o=t,c=pt(),c!==e?(r.charCodeAt(t)===10?(u=p,t++):(u=e,d===0&&g(N)),u!==e?o=c:(t=o,o=e)):(t=o,o=e),o!==e)for(;o!==e;)i.push(o),o=t,c=pt(),c!==e?(r.charCodeAt(t)===10?(u=p,t++):(u=e,d===0&&g(N)),u!==e?o=c:(t=o,o=e)):(t=o,o=e);else i=e;i!==e?(w=n,n=Ln(i)):(t=n,n=e)}else t=n,n=e;return n}function pt(){var n,a,i,o;for(n=t,a=t,i=[],r.charCodeAt(t)===32?(o=E,t++):(o=e,d===0&&g(ye));o!==e;)i.push(o),r.charCodeAt(t)===32?(o=E,t++):(o=e,d===0&&g(ye));return i.length<3?(t=a,a=e):a=i,a===e&&(r.charCodeAt(t)===9?(a=y,t++):(a=e,d===0&&g(tn))),a!==e?(i=gt(),i!==e?(w=n,n=Mn(i)):(t=n,n=e)):(t=n,n=e),n}function Ss(){var n,a,i,o,c;for(n=t,a=q(),i=t,o=[],r.charCodeAt(t)===61?(c=S,t++):(c=e,d===0&&g(Pe));c!==e;)o.push(c),r.charCodeAt(t)===61?(c=S,t++):(c=e,d===0&&g(Pe));return o.length<3?(t=i,i=e):i=o,i!==e?(o=le(),o!==e?(w=n,n=Cn()):(t=n,n=e)):(t=n,n=e),n}function vt(){var n;return n=Bs(),n===e&&(n=Ss(),n===e&&(n=bs(),n===e&&(n=Cs(),n===e&&(n=Ds(),n===e&&(n=Fs(),n===e&&(n=$s())))))),n}function $e(){var n,a;return n=t,a=Ms(),a!==e&&(w=n,a=Hn(a)),n=a,n===e&&(n=t,a=ks(),a!==e&&(w=n,a=Dn(a)),n=a,n===e&&(n=t,a=B(),a!==e&&(w=n,a=Fn(a)),n=a)),n}function B(){var n,a,i,o,c,u;if(n=t,r.substr(t,2)===T?(a=T,t+=2):(a=e,d===0&&g(Ee)),a!==e){if(i=[],o=t,c=t,d++,r.substr(t,2)===T?(u=T,t+=2):(u=e,d===0&&g(Ee)),d--,u===e?c=void 0:(t=c,c=e),c!==e?(u=B(),u!==e?o=u:(t=o,o=e)):(t=o,o=e),o!==e)for(;o!==e;)i.push(o),o=t,c=t,d++,r.substr(t,2)===T?(u=T,t+=2):(u=e,d===0&&g(Ee)),d--,u===e?c=void 0:(t=c,c=e),c!==e?(u=B(),u!==e?o=u:(t=o,o=e)):(t=o,o=e);else i=e;i!==e?(r.substr(t,2)===T?(o=T,t+=2):(o=e,d===0&&g(Ee)),o!==e?(w=n,n=Vn(i)):(t=n,n=e)):(t=n,n=e)}else t=n,n=e;if(n===e){if(n=t,r.charCodeAt(t)===42?(a=L,t++):(a=e,d===0&&g(Se)),a!==e){if(i=[],o=t,c=t,d++,r.charCodeAt(t)===42?(u=L,t++):(u=e,d===0&&g(Se)),d--,u===e?c=void 0:(t=c,c=e),c!==e?(u=B(),u!==e?o=u:(t=o,o=e)):(t=o,o=e),o!==e)for(;o!==e;)i.push(o),o=t,c=t,d++,r.charCodeAt(t)===42?(u=L,t++):(u=e,d===0&&g(Se)),d--,u===e?c=void 0:(t=c,c=e),c!==e?(u=B(),u!==e?o=u:(t=o,o=e)):(t=o,o=e);else i=e;i!==e?(r.charCodeAt(t)===42?(o=L,t++):(o=e,d===0&&g(Se)),o!==e?(w=n,n=Nn(i)):(t=n,n=e)):(t=n,n=e)}else t=n,n=e;if(n===e){if(n=t,r.charCodeAt(t)===95?(a=V,t++):(a=e,d===0&&g(we)),a!==e){if(i=[],o=t,c=t,d++,r.charCodeAt(t)===95?(u=V,t++):(u=e,d===0&&g(we)),d--,u===e?c=void 0:(t=c,c=e),c!==e?(u=B(),u!==e?o=u:(t=o,o=e)):(t=o,o=e),o!==e)for(;o!==e;)i.push(o),o=t,c=t,d++,r.charCodeAt(t)===95?(u=V,t++):(u=e,d===0&&g(we)),d--,u===e?c=void 0:(t=c,c=e),c!==e?(u=B(),u!==e?o=u:(t=o,o=e)):(t=o,o=e);else i=e;i!==e?(r.charCodeAt(t)===95?(o=V,t++):(o=e,d===0&&g(we)),o!==e?(w=n,n=In(i)):(t=n,n=e)):(t=n,n=e)}else t=n,n=e;n===e&&(n=t,a=t,i=t,d++,r.charCodeAt(t)===10?(o=p,t++):(o=e,d===0&&g(N)),d--,o===e?i=void 0:(t=i,i=e),i!==e?(r.length>t?(o=r.charAt(t),t++):(o=e,d===0&&g(F)),o!==e?(i=[i,o],a=i):(t=a,a=e)):(t=a,a=e),a!==e&&(w=n,a=Pn()),n=a)}}return n}function ke(){var n,a,i,o;if(n=t,a=[],i=$e(),i!==e)for(;i!==e;)a.push(i),i=$e();else a=e;return a!==e?(r.charCodeAt(t)===10?(i=p,t++):(i=e,d===0&&g(N)),i===e&&(i=t,d++,r.length>t?(o=r.charAt(t),t++):(o=e,d===0&&g(F)),d--,o===e?i=void 0:(t=i,i=e)),i!==e?(w=n,n=Bn(a,i)):(t=n,n=e)):(t=n,n=e),n}function ws(){var n,a,i;if(n=t,a=[],i=ke(),i!==e)for(;i!==e;)a.push(i),i=ke();else a=e;return a!==e?(i=le(),i!==e?n=a:(t=n,n=e)):(t=n,n=e),n}function ze(){var n,a,i,o,c,u;for(n=t,a=[],i=r.charAt(t),M.test(i)?t++:(i=e,d===0&&g(C));i!==e;)a.push(i),i=r.charAt(t),M.test(i)?t++:(i=e,d===0&&g(C));return i=t,r.charCodeAt(t)===60?(o=b,t++):(o=e,d===0&&g(nn)),o!==e?(c=t,d++,r.length>t?(u=r.charAt(t),t++):(u=e,d===0&&g(F)),d--,u===e?c=void 0:(t=c,c=e),c!==e?(o=[o,c],i=o):(t=i,i=e)):(t=i,i=e),i===e&&(r.substr(t,2)===he?(i=he,t+=2):(i=e,d===0&&g(sn))),i!==e?(a=[a,i],n=a):(t=n,n=e),n}function mt(){var n,a,i,o,c,u,m,$;for(n=t,a=[],i=r.charAt(t),M.test(i)?t++:(i=e,d===0&&g(C));i!==e;)a.push(i),i=r.charAt(t),M.test(i)?t++:(i=e,d===0&&g(C));if(r.charCodeAt(t)===62?(i=ge,t++):(i=e,d===0&&g(rn)),i!==e){for(o=[],c=r.charAt(t),M.test(c)?t++:(c=e,d===0&&g(C));c!==e;)o.push(c),c=r.charAt(t),M.test(c)?t++:(c=e,d===0&&g(C));if(c=[],u=t,m=t,d++,$=ze(),d--,$===e?m=void 0:(t=m,m=e),m!==e?($=$e(),$!==e?u=$:(t=u,u=e)):(t=u,u=e),u!==e)for(;u!==e;)c.push(u),u=t,m=t,d++,$=ze(),d--,$===e?m=void 0:(t=m,m=e),m!==e?($=$e(),$!==e?u=$:(t=u,u=e)):(t=u,u=e);else c=e;c!==e?(u=ze(),u!==e?(w=n,n=On(c)):(t=n,n=e)):(t=n,n=e)}else t=n,n=e;return n===e&&(n=xs(),n===e&&(n=ke())),n}function xs(){var n,a,i;return n=t,r.charCodeAt(t)===33?(a=Ot,t++):(a=e,d===0&&g(an)),a!==e?(i=ke(),i!==e?(w=n,n=qn(i)):(t=n,n=e)):(t=n,n=e),n}function Ts(){var n,a,i;if(n=t,a=[],i=mt(),i!==e)for(;i!==e;)a.push(i),i=mt();else a=e;return a!==e?(i=le(),i!==e?n=a:(t=n,n=e)):(t=n,n=e),n}function bs(){var n,a,i,o,c,u,m,$,te;for(n=t,a=q(),i=[],o=t,c=t,d++,r.substr(t,4)===pe?(u=pe,t+=4):(u=e,d===0&&g(lt)),u===e&&(u=t,r.substr(t,3)===X?(m=X,t+=3):(m=e,d===0&&g(Be)),m!==e?($=t,d++,r.length>t?(te=r.charAt(t),t++):(te=e,d===0&&g(F)),d--,te===e?$=void 0:(t=$,$=e),$!==e?(m=[m,$],u=m):(t=u,u=e)):(t=u,u=e)),d--,u===e?c=void 0:(t=c,c=e),c!==e?(u=r.charAt(t),ve.test(u)?t++:(u=e,d===0&&g(xe)),u!==e?(c=[c,u],o=c):(t=o,o=e)):(t=o,o=e);o!==e;)i.push(o),o=t,c=t,d++,r.substr(t,4)===pe?(u=pe,t+=4):(u=e,d===0&&g(lt)),u===e&&(u=t,r.substr(t,3)===X?(m=X,t+=3):(m=e,d===0&&g(Be)),m!==e?($=t,d++,r.length>t?(te=r.charAt(t),t++):(te=e,d===0&&g(F)),d--,te===e?$=void 0:(t=$,$=e),$!==e?(m=[m,$],u=m):(t=u,u=e)):(t=u,u=e)),d--,u===e?c=void 0:(t=c,c=e),c!==e?(u=r.charAt(t),ve.test(u)?t++:(u=e,d===0&&g(xe)),u!==e?(c=[c,u],o=c):(t=o,o=e)):(t=o,o=e);return r.substr(t,3)===X?(o=X,t+=3):(o=e,d===0&&g(Be)),o!==e?(c=St(),c!==e?(w=t,u=Wn(),u?u=void 0:u=e,u!==e?(w=n,n=_n()):(t=n,n=e)):(t=n,n=e)):(t=n,n=e),n}function $s(){var n,a;return n=t,a=Ts(),a!==e&&(w=n,a=Kn(a)),n=a,n===e&&(n=t,a=Et(),a!==e&&(w=n,a=Un(a)),n=a),n}function ks(){var n,a,i,o,c;return d++,n=t,r.substr(t,2)===nt?(a=nt,t+=2):(a=e,d===0&&g(ln)),a!==e?(i=As(),i===e&&(i=null),o=Rs(),r.substr(t,2)===Y?(c=Y,t+=2):(c=e,d===0&&g(Oe)),c===e&&(c=null),w=n,n=jn(i,o)):(t=n,n=e),d--,n===e&&(a=e,d===0&&g(on)),n}function Rs(){var n,a,i,o,c;for(n=t,a=[],i=t,o=t,d++,r.substr(t,2)===Y?(c=Y,t+=2):(c=e,d===0&&g(Oe)),c===e&&(r.substr(t,2)===J?(c=J,t+=2):(c=e,d===0&&g(qe))),d--,c===e?o=void 0:(t=o,o=e),o!==e?(r.length>t?(c=r.charAt(t),t++):(c=e,d===0&&g(F)),c!==e?(o=[o,c],i=o):(t=i,i=e)):(t=i,i=e);i!==e;)a.push(i),i=t,o=t,d++,r.substr(t,2)===Y?(c=Y,t+=2):(c=e,d===0&&g(Oe)),c===e&&(r.substr(t,2)===J?(c=J,t+=2):(c=e,d===0&&g(qe))),d--,c===e?o=void 0:(t=o,o=e),o!==e?(r.length>t?(c=r.charAt(t),t++):(c=e,d===0&&g(F)),c!==e?(o=[o,c],i=o):(t=i,i=e)):(t=i,i=e);return w=n,a=zn(),n=a,n}function As(){var n,a,i,o,c;if(n=t,r.charCodeAt(t)===43?(a=qt,t++):(a=e,d===0&&g(cn)),a!==e&&(w=n,a=Xn()),n=a,n===e&&(n=t,r.charCodeAt(t)===45?(a=Wt,t++):(a=e,d===0&&g(fn)),a!==e&&(w=n,a=Yn()),n=a,n===e))if(n=t,a=Ls(),a!==e)if(r.charCodeAt(t)===58?(i=v,t++):(i=e,d===0&&g(at)),i!==e){for(o=[],r.charCodeAt(t)===32?(c=E,t++):(c=e,d===0&&g(ye));c!==e;)o.push(c),r.charCodeAt(t)===32?(c=E,t++):(c=e,d===0&&g(ye));w=n,n=Jn(a)}else t=n,n=e;else t=n,n=e;return n}function Ls(){var n,a,i;if(n=t,a=[],i=r.charAt(t),Ie.test(i)?t++:(i=e,d===0&&g(We)),i!==e)for(;i!==e;)a.push(i),i=r.charAt(t),Ie.test(i)?t++:(i=e,d===0&&g(We));else a=e;return a!==e&&(w=n,a=Gn()),n=a,n}function Ms(){var n,a,i,o,c,u,m;if(d++,n=t,a=q(),r.substr(t,2)===st?(i=st,t+=2):(i=e,d===0&&g(un)),i!==e){for(o=[],c=t,u=t,d++,r.substr(t,2)===G?(m=G,t+=2):(m=e,d===0&&g(_e)),d--,m===e?u=void 0:(t=u,u=e),u!==e?(r.length>t?(m=r.charAt(t),t++):(m=e,d===0&&g(F)),m!==e?(u=[u,m],c=u):(t=c,c=e)):(t=c,c=e);c!==e;)o.push(c),c=t,u=t,d++,r.substr(t,2)===G?(m=G,t+=2):(m=e,d===0&&g(_e)),d--,m===e?u=void 0:(t=u,u=e),u!==e?(r.length>t?(m=r.charAt(t),t++):(m=e,d===0&&g(F)),m!==e?(u=[u,m],c=u):(t=c,c=e)):(t=c,c=e);r.substr(t,2)===G?(c=G,t+=2):(c=e,d===0&&g(_e)),c!==e?(w=n,n=Qn()):(t=n,n=e)}else t=n,n=e;return d--,n===e&&(a=e,d===0&&g(dn)),n}function Cs(){var n,a,i,o,c;return n=t,a=q(),i=Hs(),i!==e?(o=Xe(),o!==e?(c=le(),c!==e?(w=n,n=Zn(i)):(t=n,n=e)):(t=n,n=e)):(t=n,n=e),n}function Hs(){var n,a,i;if(n=t,a=[],r.charCodeAt(t)===35?(i=rt,t++):(i=e,d===0&&g(ct)),i!==e)for(;i!==e;)a.push(i),r.charCodeAt(t)===35?(i=rt,t++):(i=e,d===0&&g(ct));else a=e;return a!==e&&(w=n,a=es()),n=a,n}function Ds(){var n,a,i;if(n=t,a=[],i=yt(),i!==e)for(;i!==e;)a.push(i),i=yt();else a=e;return a!==e?(i=Et(),i===e&&(i=null),w=n,n=ts(a)):(t=n,n=e),n}function yt(){var n,a,i,o,c;return n=t,a=q(),r.charCodeAt(t)===61?(i=S,t++):(i=e,d===0&&g(Pe)),i!==e?(o=Xe(),o!==e?(c=le(),c!==e?(w=n,n=ns(o)):(t=n,n=e)):(t=n,n=e)):(t=n,n=e),n}function Et(){var n,a;return n=t,r.charCodeAt(t)===10?(a=p,t++):(a=e,d===0&&g(N)),a!==e&&(w=n,a=ss()),n=a,n}function le(){var n,a;return r.charCodeAt(t)===10?(n=p,t++):(n=e,d===0&&g(N)),n===e&&(n=t,d++,r.length>t?(a=r.charAt(t),t++):(a=e,d===0&&g(F)),d--,a===e?n=void 0:(t=n,n=e)),n}function Fs(){var n,a,i,o,c,u,m,$;if(n=t,a=q(),i=Is(),i!==e){for(o=[],c=r.charAt(t),M.test(c)?t++:(c=e,d===0&&g(C));c!==e;)o.push(c),c=r.charAt(t),M.test(c)?t++:(c=e,d===0&&g(C));c=Ns(),r.charCodeAt(t)===10?(u=p,t++):(u=e,d===0&&g(N)),u!==e?(m=Vs(),m===e&&(m=null),$=ws(),$!==e?(w=n,n=rs(i,c,m,$)):(t=n,n=e)):(t=n,n=e)}else t=n,n=e;return n}function Vs(){var n,a,i,o,c,u;if(n=t,a=q(),r.charCodeAt(t)===40?(i=Ve,t++):(i=e,d===0&&g(Ke)),i!==e){for(o=[],c=r.charAt(t),Q.test(c)?t++:(c=e,d===0&&g(Z));c!==e;)o.push(c),c=r.charAt(t),Q.test(c)?t++:(c=e,d===0&&g(Z));r.charCodeAt(t)===41?(c=Ne,t++):(c=e,d===0&&g(Ue)),c!==e?(r.charCodeAt(t)===10?(u=p,t++):(u=e,d===0&&g(N)),u!==e?(w=n,n=is()):(t=n,n=e)):(t=n,n=e)}else t=n,n=e;return n}function Ns(){var n,a,i,o,c,u,m;for(n=t,a=[],i=t,o=[],c=r.charAt(t),M.test(c)?t++:(c=e,d===0&&g(C));c!==e;)o.push(c),c=r.charAt(t),M.test(c)?t++:(c=e,d===0&&g(C));if(r.charCodeAt(t)===40?(c=Ve,t++):(c=e,d===0&&g(Ke)),c!==e){for(u=[],m=r.charAt(t),Q.test(m)?t++:(m=e,d===0&&g(Z));m!==e;)u.push(m),m=r.charAt(t),Q.test(m)?t++:(m=e,d===0&&g(Z));r.charCodeAt(t)===41?(m=Ne,t++):(m=e,d===0&&g(Ue)),m!==e?(o=[o,c,u,m],i=o):(t=i,i=e)}else t=i,i=e;for(;i!==e;){for(a.push(i),i=t,o=[],c=r.charAt(t),M.test(c)?t++:(c=e,d===0&&g(C));c!==e;)o.push(c),c=r.charAt(t),M.test(c)?t++:(c=e,d===0&&g(C));if(r.charCodeAt(t)===40?(c=Ve,t++):(c=e,d===0&&g(Ke)),c!==e){for(u=[],m=r.charAt(t),Q.test(m)?t++:(m=e,d===0&&g(Z));m!==e;)u.push(m),m=r.charAt(t),Q.test(m)?t++:(m=e,d===0&&g(Z));r.charCodeAt(t)===41?(m=Ne,t++):(m=e,d===0&&g(Ue)),m!==e?(o=[o,c,u,m],i=o):(t=i,i=e)}else t=i,i=e}return w=n,a=as(),n=a,n}function Is(){var n,a,i,o;if(n=t,a=Ps(),a!==e?(w=t,i=os(a),i?i=void 0:i=e,i!==e?(w=n,n=ls(a)):(t=n,n=e)):(t=n,n=e),n===e)if(n=t,r.charCodeAt(t)===64?(a=_t,t++):(a=e,d===0&&g(hn)),a!==e){if(i=[],o=r.charAt(t),me.test(o)?t++:(o=e,d===0&&g(Te)),o!==e)for(;o!==e;)i.push(o),o=r.charAt(t),me.test(o)?t++:(o=e,d===0&&g(Te));else i=e;i!==e?(w=n,n=cs()):(t=n,n=e)}else t=n,n=e;return n}function Ps(){var n,a,i,o;if(n=t,a=r.charAt(t),Qt.test(a)?t++:(a=e,d===0&&g(gn)),a!==e){for(i=[],o=r.charAt(t),me.test(o)?t++:(o=e,d===0&&g(Te));o!==e;)i.push(o),o=r.charAt(t),me.test(o)?t++:(o=e,d===0&&g(Te));w=n,n=fs()}else t=n,n=e;return n}function St(){var n,a,i,o;return n=t,d++,r.length>t?(a=r.charAt(t),t++):(a=e,d===0&&g(F)),d--,a===e?n=void 0:(t=n,n=e),n===e&&(n=t,r.charCodeAt(t)===10?(a=p,t++):(a=e,d===0&&g(N)),a!==e?(i=t,d++,r.length>t?(o=r.charAt(t),t++):(o=e,d===0&&g(F)),d--,o===e?i=void 0:(t=i,i=e),i!==e?(a=[a,i],n=a):(t=n,n=e)):(t=n,n=e),n===e&&(r.substr(t,2)===J?(n=J,t+=2):(n=e,d===0&&g(qe)))),n}function Xe(){var n,a,i;if(n=t,a=[],i=r.charAt(t),ve.test(i)?t++:(i=e,d===0&&g(xe)),i!==e)for(;i!==e;)a.push(i),i=r.charAt(t),ve.test(i)?t++:(i=e,d===0&&g(xe));else a=e;return a!==e&&(w=n,a=ds()),n=a,n}function q(){var n,a;for(n=[],a=r.charAt(t),M.test(a)?t++:(a=e,d===0&&g(C));a!==e;)n.push(a),a=r.charAt(t),M.test(a)?t++:(a=e,d===0&&g(C));return n}function Bs(){var n,a,i,o;return n=t,a=Os(),a!==e?(i=Xe(),i!==e?(o=St(),o!==e?(w=n,n=us()):(t=n,n=e)):(t=n,n=e)):(t=n,n=e),n}function Os(){var n,a,i,o,c,u;return n=t,a=q(),i=t,r.charCodeAt(t)===46?(o=Kt,t++):(o=e,d===0&&g(pn)),o!==e?(c=t,d++,u=r.charAt(t),Ie.test(u)?t++:(u=e,d===0&&g(We)),d--,u!==e?(t=c,c=void 0):c=e,c!==e?(o=[o,c],i=o):(t=i,i=e)):(t=i,i=e),i===e&&(i=t,o=r.substr(t,8),o.toLowerCase()===Ut?t+=8:(o=e,d===0&&g(vn)),o===e&&(o=r.substr(t,7),o.toLowerCase()===jt?t+=7:(o=e,d===0&&g(mn)),o===e&&(o=r.substr(t,3),o.toLowerCase()===zt?t+=3:(o=e,d===0&&g(yn)),o===e&&(o=r.substr(t,3),o.toLowerCase()===Xt?t+=3:(o=e,d===0&&g(En)),o===e&&(o=r.substr(t,3),o.toLowerCase()===Yt?t+=3:(o=e,d===0&&g(Sn)),o===e&&(o=r.substr(t,3),o.toLowerCase()===Jt?t+=3:(o=e,d===0&&g(wn))))))),o!==e?(c=r.charAt(t),Zt.test(c)?t++:(c=e,d===0&&g(xn)),c!==e?(o=[o,c],i=o):(t=i,i=e)):(t=i,i=e)),i!==e?(a=[a,i],n=a):(t=n,n=e),n}if(ie=h(),s.peg$library)return{peg$result:ie,peg$currPos:t,peg$FAILED:e,peg$maxFailExpected:be,peg$maxFailPos:I};if(ie!==e&&t===r.length)return ie;throw ie!==e&&t<r.length&&g(gs()),dt(be,I<r.length?r.charAt(I):null,I<r.length?oe(I,I+1):oe(I,I))}Rt.exports={StartRules:["Script"],SyntaxError:W,parse:er}});var wr={};wt(wr,{default:()=>Fe});module.exports=Tt(wr);var Bt=require("obsidian");j();var De=require("obsidian");var Pt=require("@codemirror/commands"),Me=require("@codemirror/state"),O=require("@codemirror/view");var Qe=Xs(At());function tr(r,s,e,l=""){let f=r.slice(s.start,s.end),h=r.slice(0,s.start),p=r.slice(s.end);return e>=s.end?h+p.slice(0,e-s.end)+f+l+p.slice(e-s.end):r.slice(0,e)+f+l+r.slice(e,s.start)+p}function nr(r,s,e){let l=r.slice(0,s.start),f=r.slice(s.end);return l+e+f}var Ze=class{constructor(){this.documents=new Map;this.documents.set("",(0,Qe.parse)("",{}))}get(s){let e=this.documents.get(s);if(e===void 0)throw new Error(`No fountain file stored at "${s}"`);if(typeof e=="string"){let l=(0,Qe.parse)(e,{});if("error"in l)throw new Error("unparsable script found");return this.documents.set(s,l),l}return e}set(s,e){let l=this.documents.get(s);(l===void 0||typeof l=="string"||l.document!==e)&&this.documents.set(s,e)}replaceText(s,e,l){let h=this.get(s).document,p=nr(h,e,l);this.set(s,p)}moveSceneInScript(s,e,l){let h=this.get(s).document,p=h.slice(e.end-e.start-2,e.end-e.start),v=p===`

`?"":p[1]===`
`?`
`:`

`,E=tr(h,e,l,v);this.set(s,E)}moveScene(s,e,l,f){if(s===l)this.moveSceneInScript(s,e,f);else{let h=this.getText(s,e);this.replaceText(s,e,"");let p=h.slice(h.length-2,h.length),v=p===`

`?"":p[1]===`
`?`
`:`

`;this.replaceText(l,{start:f,end:f},h+v)}}getText(s,e){return this.get(s).document.slice(e.start,e.end)}duplicateScene(s,e){let f=this.get(s).document,h=f.slice(e.start,e.end),p=h.slice(-2),v=p===`

`?"":p[1]===`
`?`
`:`

`,E=f.slice(0,e.end)+v+h+f.slice(e.end);this.set(s,E)}},H=new Ze;var Lt=require("obsidian"),Le=class extends Lt.FuzzySuggestModal{constructor(e,l,f,h){super(e);this.items=f;this.callback=h;this.setTitle(l)}getItems(){return this.items}getItemText(e){return e}onChooseItem(e,l){this.callback(e)}};var re=require("obsidian");var Mt=require("@codemirror/state"),A=require("@codemirror/view");j();var et=class{constructor(s,e){this.getPath=e;this.bold=A.Decoration.mark({class:"bold"}),this.italics=A.Decoration.mark({class:"italics"}),this.underline=A.Decoration.mark({class:"underline"}),this.boneyard=A.Decoration.mark({class:"boneyard"}),this.noteSymbolPlus=A.Decoration.mark({class:"note-symbol-plus"}),this.noteSymbolMinus=A.Decoration.mark({class:"note-symbol-minus"}),this.noteTodo=A.Decoration.mark({class:"note-todo"}),this.note=A.Decoration.mark({class:"note"}),this.decorations=this.buildDecorations(s)}update(s){(s.docChanged||s.viewportChanged)&&(H.set(this.getPath(),s.view.state.doc.toString()),this.decorations=this.buildDecorations(s.view))}destroy(){}applyTextDecoration(s,e){let l={bold:this.bold,italics:this.italics,underline:this.underline};s.add(e.range.start,e.range.end,l[e.kind]);for(let f of e.elements)f.kind!=="text"&&this.applyTextDecoration(s,f)}decorateLines(s,e){for(let l of e)for(let f of l.elements)switch(f.kind){case"text":break;case"bold":case"italics":case"underline":this.applyTextDecoration(s,f);break;case"boneyard":s.add(f.range.start,f.range.end,this.boneyard);break;case"note":{let h=this.note;f.noteKind==="+"?h=this.noteSymbolPlus:f.noteKind==="-"?h=this.noteSymbolMinus:f.noteKind==="todo"&&(h=this.noteTodo),s.add(f.range.start,f.range.end,h);break}}}buildDecorations(s){let e=new Mt.RangeSetBuilder,l=H.get(this.getPath()),f=A.Decoration.mark({class:"scene-heading"}),h=A.Decoration.mark({class:"section"}),p=A.Decoration.mark({class:"synopsis"}),v=A.Decoration.mark({class:"dialogue-parenthetical"}),E=A.Decoration.mark({class:"dialogue-character"}),y=A.Decoration.mark({class:"dialogue-words"}),S=A.Decoration.mark({class:"action"}),T=A.Decoration.mark({class:"page-break"}),L=A.Decoration.mark({class:"transition"});if(l.titlePage!==null)for(let b of l.titlePage)for(let he of b.values)for(let ge of he)ge.kind!=="text"&&this.applyTextDecoration(e,ge);let V={start:s.viewport.from,end:s.viewport.to};try{for(let b of l.script)if(Je(b.range,V))switch(b.kind){case"scene":e.add(b.range.start,b.range.end,f);break;case"section":e.add(b.range.start,b.range.end,h);break;case"synopsis":e.add(b.range.start,b.range.end,p);break;case"page-break":e.add(b.range.start,b.range.end,T);break;case"dialogue":e.add(b.characterRange.start,b.characterExtensionsRange.end,E),b.parenthetical!==null&&e.add(b.parenthetical.start,b.parenthetical.end,v),b.lines.length>0&&(e.add(b.lines[0].range.start,b.lines[b.lines.length-1].range.end,y),this.decorateLines(e,b.lines));break;case"action":e.add(b.range.start,b.range.end,S),this.decorateLines(e,b.lines);break;case"transition":e.add(b.range.start,b.range.end,L);break;default:break}}catch(b){console.log("decoration failed",b)}return e.finish()}},sr={decorations:r=>r.decorations};function Ct(r){return A.ViewPlugin.define(s=>new et(s,r),sr)}var de=require("obsidian");j();function tt(r){return{start:r.end,end:r.end}}function _(r,s){return r.createDiv({attr:s?R(tt(s)):{},text:U})}j();function rr(r){var s;try{let e=(s=r.dataTransfer)==null?void 0:s.getData("application/json");return e?JSON.parse(e):null}catch(e){return null}}function ir(r,s,e,l,f){let h=rr(f);if(!h||h.range.start===e.start)return;let p=r.classList.contains("drop-left");!p&&!r.classList.contains("drop-right")||(r.classList.remove("drop-left"),r.classList.remove("drop-right"),f.preventDefault(),H.moveScene(h.path,h.range,s,p?e.start:e.end),l.requestSave(),l.reRender())}function ar(r,s,e){e.preventDefault();let l=r.getBoundingClientRect(),f=e.clientX,p=(Math.min(Math.max(f,l.left),l.right)-l.left)/l.width*100;p>70?(r.classList.add("drop-right"),r.classList.remove("drop-left")):p<30?(r.classList.add("drop-left"),r.classList.remove("drop-right")):(r.classList.remove("drop-left"),r.classList.remove("drop-right"))}function or(r,s,e){e.dataTransfer&&(e.dataTransfer.clearData(),e.dataTransfer.setData("application/json",JSON.stringify({path:r,range:s})))}function lr(r,s,e,l){e.addEventListener("dragover",f=>{ar(e,l,f)}),e.addEventListener("dragleave",f=>{e.classList.remove("drop-left"),e.classList.remove("drop-right")}),e.addEventListener("drop",f=>{ir(e,r,l,s,f)}),e.addEventListener("dragstart",f=>{or(r,l,f)})}function cr(r){throw new Error(`Unexpected object: ${r}`)}function fr(r,s,e,l,f){let h=l.map(S=>H.getText(s,S)),p=createEl("textarea",{text:h.join(`
`)}),v=r.createDiv({cls:"edit-buttons"}),E=v.createEl("button",{text:"Cancel"}),y=v.createEl("button",{text:"OK"});r.replaceWith(p,v),p.focus(),E.addEventListener("click",()=>{f.reRender()}),y.addEventListener("click",()=>{let S=p.value.split(`
`).map(T=>`= ${T}`).join(`
`);H.replaceText(s,e,`${S}
`),f.requestSave(),f.reRender()})}function dr(r,s,e,l,f){let h=r.querySelector(".scene-heading"),p=e.unsafeExtractRaw(l),v=p.replace(/\n{1,2}/,""),E=p.length-v.length;if(h){let y=createEl("input",{cls:"scene-heading",type:"text",value:v});y.addEventListener("keyup",S=>{S.key==="Escape"?(f.reRender(),S.preventDefault()):S.key==="Enter"&&(H.replaceText(s,l,y.value+`
`.repeat(E)),f.requestSave(),f.reRender(),S.preventDefault())}),h.replaceWith(y),y.focus()}}function Ht(r,s,e,l,f,h){let p=(l==null?void 0:l.range)||{start:f,end:f};r.createDiv({attr:R(p)},v=>{v.addEventListener("click",E=>{fr(v,s,p,(l==null?void 0:l.linesOfText)||[],h)});for(let E of(l==null?void 0:l.linesOfText)||[])v.createDiv({cls:"synopsis",attr:R(E),text:e.unsafeExtractRaw(E,!0)});l||v.createDiv({cls:["synopsis","show-on-hover"],text:"Click to edit"})})}function ur(r,s,e,l,f){if(l.scene){let h=l.scene,p=l.content;r.createDiv({cls:"screenplay-index-card",attr:{draggable:!0,...R(l.range)}},v=>{lr(s,f,v,l.range),v.createEl("h3",{cls:"scene-heading",attr:R(h.range),text:e.unsafeExtractRaw(h.range)},y=>{y.addEventListener("click",S=>{dr(v,s,e,h.range,f)})}),v.createDiv({cls:["index-card-buttons"]},y=>{y.createEl("button",{cls:"clickable-icon"},S=>{(0,de.setIcon)(S,"ellipsis"),S.addEventListener("click",T=>{let L=new de.Menu;L.addItem(V=>{V.setTitle("Copy").setIcon("copy").onClick(()=>{H.duplicateScene(s,l.range),f.requestSave(),f.reRender()})}),L.addItem(V=>{V.setTitle("Edit").setIcon("edit").onClick(()=>{f.startEditModeHere(l.range)})}),L.addItem(V=>{V.setTitle("Delete").onClick(()=>{H.replaceText(s,l.range,""),f.requestSave(),f.reRender()})}),L.showAtMouseEvent(T)})})}),Ht(v,s,e,l.synopsis,h.range.end,f);let E=fe(p).filter(y=>y.noteKind==="todo");for(let y of E)v.createDiv({},S=>{e.styledTextToHtml(S,[y],{},!1),S.addEventListener("click",()=>f.startEditModeHere(y.range))})})}}function Dt(r,s,e,l,f){var h;if(l.section){let p=e.unsafeExtractRaw(l.section.range),v=`h${(h=l.section.depth)!=null?h:1}`;p.toLowerCase().replace(/^ *#+ */,"").trimEnd()==="boneyard"&&r.createEl("hr"),r.createEl(v,{cls:"section",attr:{"data-start":l.section.range.start},text:p})}l.synopsis&&Ht(r,s,e,l.synopsis,l.synopsis.range.start,f),r.createDiv({cls:"screenplay-index-cards"},p=>{for(let v of l.content)switch(v.kind){case"scene":ur(p,s,e,v,f);break;case"section":Dt(p,s,e,v,f);break;default:cr(v);break}p.createDiv({cls:["screenplay-index-card","dashed"],attr:{}},v=>{(0,de.setIcon)(v,"plus"),v.addEventListener("click",E=>{let y=l.range;H.replaceText(s,tt(y),`.SCENE HEADING

`),f.requestSave(),f.reRender()})})})}function Ft(r,s,e,l){let f=e.structure();r.empty();for(let h of f)Dt(r,s,e,h,l)}j();function hr(r,s,e,l){Vt(r,e,["action"],s.lines,!0,l)&&_(r,s.range)}function gr(r,s,e,l,f){if(r.createDiv({attr:R(s.characterRange)},p=>{p.createEl("h4",{cls:"dialogue-character",text:e.unsafeExtractRaw({start:s.characterRange.start,end:s.characterExtensionsRange.end})})}),s.parenthetical){let p=s.parenthetical;r.createDiv({attr:R(p)},v=>{v.createDiv({cls:"dialogue-parenthetical",text:e.unsafeExtractRaw(p)})})}let h=f&&e.charactersOf(s).includes(f)?["blackout","dialogue-words"]:["dialogue-words"];Vt(r,e,h,s.lines,!1,l),_(r,s.range)}function pr(r,s="range"){let e=r.getAttribute(`data-${s}`);if(e===null)return null;let l=e.split(",");if(l.length!==2)return null;try{let f=Number.parseInt(l[0]),h=Number.parseInt(l[1]);return{start:f,end:h}}catch(f){return null}}function Vt(r,s,e,l,f,h){let p=!0;for(let v of l){let E=v.centered?"centered":"",y=E?[E,...e]:e;r.createDiv({attr:R(v.range)},S=>{let T=S.createDiv({cls:y});if(v.elements.length===0)T.appendText(U);else{let L=!s.styledTextToHtml(T,v.elements,h,f);p=p&&L}})}return!p||l.length>0}function vr(r,s,e,l){if(!l.hideSynopsis){for(let f of e.linesOfText)r.createDiv({cls:"synopsis",attr:R(f),text:s.unsafeExtractRaw(f,!0)});_(r,e.range)}}function mr(r,s,e,l){let f=!1,h=p=>{var v;if(!f)switch(p.kind){case"action":hr(r,p,s,e);break;case"scene":r.createEl("h3",{cls:"scene-heading",attr:R(p.range),text:s.unsafeExtractRaw(p.range)}),_(r,p.range);break;case"synopsis":vr(r,s,p,e);break;case"section":{let E=s.unsafeExtractRaw(p.range);if(E.toLowerCase().replace(/^ *#+ */,"").trimEnd()==="boneyard"){if(e.hideBoneyard){f=!0;return}r.createEl("hr")}let y=`h${(v=p.depth)!=null?v:1}`;r.createEl(y,{cls:"section",attr:R(p.range),text:E})}break;case"dialogue":gr(r,p,s,e,l);break;case"transition":{let E=s.unsafeExtractRaw(p.range);r.createDiv({cls:"transition",attr:R(p.range),text:E}),_(r,p.range)}break;case"page-break":r.createEl("hr",{attr:R(p.range)});break}};for(let p of s.script)h(p)}var yr=U.repeat(3);function Er(r,s){let e=s.titlePage;if(e.length>0){for(let l of e)if(l.values.length===1)r.createDiv({},f=>{f.appendText(`${l.key}: `),s.styledTextToHtml(f,l.values[0],{},!0)});else{r.createDiv({text:`${l.key}: `});for(let f of l.values)r.createDiv({},h=>{h.appendText(yr),s.styledTextToHtml(h,f,{},!0)})}_(r),r.createEl("hr"),_(r)}}function Nt(r,s,e,l){Er(r,s),mr(r,s,e,l)}function It(r){let s=r.parentNode.getBoundingClientRect().top;for(let e of r.children){let l=e;if(l.getBoundingClientRect().bottom>=s){let f=pr(l);if(f===null)continue;return f}}return null}var Ce="fountain";var D=class{constructor(s,e,l,f,h){this.requestSave=h;this.contentEl=s,this.startEditModeHere=f,this.path=l,this.pstate=e}get showMode(){return this.pstate.mode}get blackout(){var s,e;return(e=(s=this.pstate.rehearsal)==null?void 0:s.character)!=null?e:null}script(){return H.get(this.path)}stopRehearsalMode(){this.pstate.rehearsal&&(this.pstate={...this.pstate,...this.pstate.rehearsal.previousShowHideSettings},this.pstate.rehearsal=void 0,this.render())}startRehearsalMode(s){this.pstate.rehearsal={character:s,previousShowHideSettings:{hideBoneyard:this.pstate.hideBoneyard||!1,hideSynopsis:this.pstate.hideSynopsis||!1,hideNotes:this.pstate.hideNotes||!1}},this.pstate.hideBoneyard=!0,this.pstate.hideNotes=!0,this.pstate.hideSynopsis=!0,this.render()}blackoutCharacter(){return this.blackout}toggleBlackoutHandler(s){s.target.classList.toggle("blackout")}installToggleBlackoutHandlers(){let s=this.contentEl.querySelectorAll(".blackout");for(let e of s)e.addEventListener("click",l=>{this.toggleBlackoutHandler(l)})}render(){var f;this.contentEl.empty();let s={requestSave:()=>{this.requestSave()},reRender:()=>{this.render()},startEditModeHere:h=>{this.startEditModeHere(h)},startReadingModeHere:h=>{this.scrollToHere(h)}},e=this.script();if("error"in e){console.log("error parsing script",e);return}let l=this.contentEl.createDiv(this.showMode==="index-cards"?void 0:"screenplay");switch(this.showMode){case"index-cards":Ft(l,this.path,e,s);break;case"script":Nt(l,e,this.pstate,(f=this.blackout)!=null?f:void 0);break}this.blackout&&this.installToggleBlackoutHandlers()}scrollToHere(s){let e=()=>{let l=document.querySelector(`[data-range^="${s.start},"]`);l==null||l.scrollIntoView()};this.pstate.mode!=="script"?(this.toggleIndexCards(),requestAnimationFrame(()=>{e()})):e()}setPersistentState(s){this.pstate=s,this.render()}setShowHideSettings(s){this.pstate={...this.pstate,...s},this.render()}toggleIndexCards(){this.pstate.mode=this.pstate.mode==="index-cards"?"script":"index-cards",this.render()}getViewData(){return H.get(this.path).document}setViewData(s,e,l){this.path=s,H.set(s,e),this.render()}clear(){}rangeOfFirstVisibleLine(){let s=this.contentEl.querySelector(".screenplay");return s===null?null:It(s)}};function Sr(r){let s=r;for(;s!==null;){if(s.scrollHeight>s.clientHeight)return s;s=s.parentNode}return document.scrollingElement||document.documentElement}var z=class{constructor(s,e,l,f){s.empty();let h=s.createDiv("custom-editor-component"),p=O.EditorView.theme({"&":{fontSize:"12pt"},".cm-content":{fontFamily:"inherit",lineHeight:"inherit"},".cm-scroller":{fontFamily:"inherit",lineHeight:"inherit"}}),v=Me.EditorState.create({doc:l,extensions:[p,(0,Pt.history)(),(0,O.drawSelection)(),O.EditorView.editorAttributes.of({class:"screenplay"}),O.EditorView.lineWrapping,Ct(()=>e),O.EditorView.updateListener.of(E=>{E.docChanged&&f()})]});this.path=e,this.cmEditor=new O.EditorView({state:v,parent:h})}script(){return H.get(this.path)}setViewData(s,e,l){this.path=s,this.cmEditor.dispatch({changes:{from:0,to:this.cmEditor.state.doc.length,insert:e}})}getViewData(){return this.cmEditor.state.doc.toString()}clear(){}destroy(){this.cmEditor.destroy()}scrollToHere(s){this.cmEditor.dispatch({effects:O.EditorView.scrollIntoView(s.start,{y:"start"}),selection:Me.EditorSelection.single(s.start)}),this.cmEditor.focus()}firstVisibleLine(){var h;let e=((h=Sr(this.cmEditor.scrollDOM))!=null?h:this.cmEditor.scrollDOM).getBoundingClientRect(),l=this.cmEditor.posAtCoords({x:e.x,y:e.y+5}),f=this.cmEditor.lineBlockAt(l!=null?l:0);return{start:f.from,end:f.to+1}}},K=class extends re.TextFileView{constructor(s){super(s),this.readonlyViewState={mode:"script"},this.state=new D(this.contentEl,this.readonlyViewState,"",e=>this.startEditModeHere(e),()=>this.requestSave()),this.toggleEditAction=this.addAction("edit","Toggle Edit/Readonly",e=>{this.toggleEditMode(),this.app.workspace.requestSaveLayout()}),this.showViewMenuAction=this.addAction("eye","View options",e=>this.showViewMenu(e)),this.stopRehearsalModeAction=this.addAction("brain","Stop rehearsal",e=>{this.stopRehearsalMode()}),this.stopRehearsalModeAction.hide()}showViewMenu(s){if(this.state instanceof D){let e=h=>{if(this.state instanceof D){let p=this.state.pstate;this.state.setShowHideSettings({...p,...h}),this.app.workspace.requestSaveLayout()}},l=new re.Menu,f=this.state.pstate;this.blackoutCharacter()||(l.addItem(h=>h.setTitle(f.mode==="script"?"Index cards":"Script").onClick(()=>{this.state instanceof D&&(this.state.toggleIndexCards(),this.app.workspace.requestSaveLayout())})),l.addSeparator()),f.mode!=="index-cards"&&(l.addItem(h=>h.setTitle("Synopsis").setChecked(!f.hideSynopsis).onClick(()=>e({hideSynopsis:!f.hideSynopsis}))),l.addItem(h=>h.setTitle("Notes").setChecked(!f.hideNotes).onClick(()=>e({hideNotes:!f.hideNotes}))),l.addItem(h=>h.setTitle("Boneyard").setChecked(!f.hideBoneyard).onClick(()=>e({hideBoneyard:!f.hideBoneyard}))),l.addSeparator(),this.blackoutCharacter()?l.addItem(h=>{h.setTitle("Stop Rehearsal").onClick(()=>{this.stopRehearsalMode()})}):l.addItem(h=>h.setTitle("Rehearsal").onClick(()=>this.rehearsalModeClicked()))),l.showAtMouseEvent(s)}}rehearsalModeClicked(){let s=this.script();"error"in s||new Le(this.app,"Whose lines?",Array.from(s.allCharacters.values()),e=>this.startRehearsalMode(e)).open()}startEditModeHere(s){this.switchToEditMode(),this.scrollToHere(s)}startReadingModeHere(s){this.switchToReadonlyMode(),this.scrollToHere(s)}scrollToHere(s){this.state.scrollToHere(s)}isEditMode(){return this.state instanceof z}switchToEditMode(){this.state instanceof z||this.toggleEditMode()}switchToReadonlyMode(){this.state instanceof D||this.toggleEditMode()}startRehearsalMode(s){this.switchToReadonlyMode(),this.state instanceof D&&(this.showViewMenuAction.hide(),this.stopRehearsalModeAction.show(),this.state.startRehearsalMode(s),this.app.workspace.requestSaveLayout())}blackoutCharacter(){return this.state instanceof D?this.state.blackoutCharacter():null}stopRehearsalMode(){this.state instanceof D&&(this.state.stopRehearsalMode(),this.showViewMenuAction.show(),this.stopRehearsalModeAction.hide(),this.app.workspace.requestSaveLayout())}script(){return this.state.script()}toggleEditMode(){var e,l,f,h;let s=this.state.getViewData();if(this.state instanceof z){this.showViewMenuAction.show();let p=this.state.firstVisibleLine();this.state.destroy(),this.state=new D(this.contentEl,this.readonlyViewState,(l=(e=this.file)==null?void 0:e.path)!=null?l:"",E=>this.startEditModeHere(E),()=>this.requestSave()),this.state.render();let v=this.state;requestAnimationFrame(()=>{v.scrollToHere(p)})}else{this.showViewMenuAction.hide(),this.readonlyViewState=this.state.pstate;let p=this.state.rangeOfFirstVisibleLine();this.state=new z(this.contentEl,(h=(f=this.file)==null?void 0:f.path)!=null?h:"",s,this.requestSave),p!==null&&this.state.scrollToHere(p)}this.toggleEditAction.empty(),(0,re.setIcon)(this.toggleEditAction,this.isEditMode()?"book-open":"edit")}onLoadFile(s){return super.onLoadFile(s)}onUnloadFile(s){return super.onUnloadFile(s)}getViewType(){return Ce}getDisplayText(){var s,e;return(e=(s=this.file)==null?void 0:s.basename)!=null?e:"Fountain"}getViewData(){return this.state.getViewData()}setViewData(s,e){var f;let l=(f=this.file)==null?void 0:f.path;l&&this.state.setViewData(l,s,e)}getState(){let s=super.getState(),e;return this.state instanceof D?(this.readonlyViewState=this.state.pstate,e=!1):e=!0,s.fountain={editing:e,...this.readonlyViewState},s}async setState(s,e){if(super.setState(s,e),"fountain"in s){let l=s.fountain;this.readonlyViewState=l,l.editing?this.switchToEditMode():(this.switchToReadonlyMode(),this.state instanceof D&&(this.state.setPersistentState(l),l.rehearsal&&this.startRehearsalMode(l.rehearsal.character)))}}clear(){this.state.clear(),this.state instanceof z&&(this.state.destroy(),this.state=new D(this.contentEl,this.readonlyViewState,"",s=>this.startEditModeHere(s),()=>this.requestSave()))}};var ue="obsidian-toc",He=class extends De.ItemView{constructor(s){super(s),this.updateToc=(0,De.debounce)(()=>this.render(),500,!0),this.expanded=!1,this.showTodos=!0,this.showSynopsis=!1}getViewType(){return ue}getDisplayText(){return"Table of contents of fountain script"}getIcon(){return"list-tree"}async onload(){this.registerEvent(this.app.workspace.on("active-leaf-change",s=>{(s==null?void 0:s.view)!==this&&this.updateToc()})),this.registerEvent(this.app.vault.on("modify",s=>{s.name.endsWith(".fountain")&&this.updateToc()}))}scrollActiveScriptToHere(s){var e;(e=this.theFountainView())==null||e.scrollToHere(s)}theFountainView(){let s=this.app.workspace.getMostRecentLeaf(this.app.workspace.rootSplit);return s&&s.view instanceof K?s.view:null}renderSynopsis(s,e,l){if(l)for(let f of l.linesOfText)s.createDiv({cls:"synopsis",attr:R(f),text:e.unsafeExtractRaw(f,!0)}).addEventListener("click",p=>{this.scrollActiveScriptToHere(f)})}renderTocSection(s,e,l){s.createEl("section",{},f=>{if(l.section){let h=l.section;f.createEl("h1",{cls:"section",text:e.unsafeExtractRaw(h.range)}).addEventListener("click",v=>{this.scrollActiveScriptToHere(h.range)})}this.renderSynopsis(f,e,l.synopsis);for(let h of l.content)switch(h.kind){case"section":this.renderTocSection(f,e,h);break;case"scene":{if(h.scene){let v=h.scene;f.createDiv({cls:"scene-heading",text:e.unsafeExtractRaw(v.range)}).addEventListener("click",y=>{this.scrollActiveScriptToHere(v.range)})}this.renderSynopsis(f,e,h.synopsis);let p=fe(h.content).filter(v=>v.noteKind==="todo");for(let v of p)f.createDiv({cls:"todo"},E=>{e.styledTextToHtml(E,[v],{},!1),E.addEventListener("click",()=>this.scrollActiveScriptToHere(v.range)),this.showTodos||(E.style.display="none")})}break}})}render(){let s=this.theFountainView(),e=this.contentEl;e.empty(),e.createDiv({cls:"screenplay-toc"},l=>{if(s){let f=s.script();if(!("error"in f)){l.createDiv({cls:"toc-controls"},h=>{h.createEl("input",{type:"checkbox",attr:{name:"todos",...this.showTodos?{checked:""}:{}}},p=>{p.addEventListener("change",v=>{this.showTodos=p.checked;for(let E of e.querySelectorAll(".todo"))E.style.display=this.showTodos?"block":"none"})}),h.createEl("label",{attr:{for:"todos"},text:"todos?"}),h.createEl("input",{type:"checkbox",attr:{name:"synopsis",...this.showSynopsis?{checked:""}:{}}},p=>{p.addEventListener("change",v=>{this.showSynopsis=p.checked;for(let E of e.querySelectorAll(".synopsis"))E.style.display=this.showSynopsis?"block":"none"})}),h.createEl("label",{attr:{for:"synopsis"},text:"synopsis?"})});for(let h of f.structure())this.renderTocSection(l,f,h)}}if(!this.showSynopsis)for(let f of l.querySelectorAll(".synopsis"))f.style.display="none"})}async onOpen(){this.updateToc()}async onClose(){}};var Fe=class extends Bt.Plugin{async onload(){this.registerView(Ce,s=>new K(s)),this.registerExtensions(["fountain"],Ce),this.registerView(ue,s=>new He(s)),this.registerCommands(),this.app.workspace.onLayoutReady(()=>{this.registerTocInSideBar()})}async onunload(){}async registerTocInSideBar(){let{workspace:s}=this.app,e=null,l=s.getLeavesOfType(ue);l.length>0?e=l[0]:(e=s.getRightLeaf(!1),await(e==null?void 0:e.setViewState({type:ue,active:!0})))}async newFountainDocumentCommand(){let s="Untitled",e=this.app.workspace.getActiveFile();e!==null&&e!=null&&e.parent&&(s=`${e.parent.path}/Untitled`);let l=f=>{let h=f?`${s}-${f}.fountain`:`${s}.fountain`;this.app.vault.create(h,"").then(p=>{let v=this.app.workspace.getLeaf(!1);v.openFile(p).then(()=>{v.view instanceof K&&v.view.switchToEditMode(),this.app.workspace.setActiveLeaf(v,{focus:!0})})},()=>{l(f?f+1:1)})};l(null)}toggleFountainEditModeCommand(s){let e=this.app.workspace.getActiveViewOfType(K);return s?e!==null:(e&&e.toggleEditMode(),!0)}registerCommands(){this.addRibbonIcon("square-pen","New fountain document",s=>{this.newFountainDocumentCommand()}),this.addCommand({id:"new-fountain-document",name:"New fountain document",callback:()=>{this.newFountainDocumentCommand()}}),this.addCommand({id:"toggle-fountain-edit-mode",name:"Toggle edit mode",checkCallback:s=>{this.toggleFountainEditModeCommand(s)}})}};

/* nosourcemap */